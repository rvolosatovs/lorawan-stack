// Copyright Â© 2018 The Things Network Foundation, distributed under the MIT license (see LICENSE file)

syntax = "proto3";

import "github.com/gogo/protobuf/gogoproto/gogo.proto";
import "github.com/TheThingsNetwork/ttn/api/application.proto";
import "github.com/TheThingsNetwork/ttn/api/client.proto";
import "github.com/TheThingsNetwork/ttn/api/collaborator.proto";
import "github.com/TheThingsNetwork/ttn/api/auth.proto";
import "github.com/TheThingsNetwork/ttn/api/rights.proto";
import "github.com/TheThingsNetwork/ttn/api/identifiers.proto";
import "github.com/TheThingsNetwork/ttn/api/gateway.proto";
import "github.com/TheThingsNetwork/ttn/api/user.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/field_mask.proto";

package ttn.v3;

option go_package = "github.com/TheThingsNetwork/ttn/pkg/ttnpb";

message PullConfigurationRequest {
  // gateway_id is the gateway's ID to be fetched in the stream.
  GatewayIdentifier gateway_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  // projection_mask is the symbolic set of fields that will be filtered in the
  // response. If empty all fields will be returned.
  google.protobuf.FieldMask projection_mask = 2;
}

// GtwGr implements a Gateway Registry service.
service GtwGr {
  // PullConfiguration sends a new DeviceConfiguration, with all the latest values,
  // at connection and when a gateway's configuration is updated.
  rpc PullConfiguration(PullConfigurationRequest) returns (stream Gateway);
}

message IdentityServerSettings {
  // blacklisted_ids is the list of IDs that are not allowed to use in the network.
  repeated string blacklisted_ids = 1 [(gogoproto.customname) = "BlacklistedIDs"];

  message UserRegistrationFlow {
    // skip_validation denotes whether if users need to validate their email
    // account after registration or this step is skipped.
    bool skip_validation = 1;

    // self_registration denotes whether people can register themselves an user
    // account or they need to be granted an invitation to do so.
    bool self_registration = 2;

    // admin_approval denotes whether or not admins need to validate user accounts
    // after they are registered.
    bool admin_approval = 3;
  }
  // user_registration are the settings used to configure the user registration flow.
  UserRegistrationFlow user_registration = 2 [(gogoproto.nullable) = false];

  // validation_token_ttl denotes the time an account validation token is valid
  // after being issued.
  google.protobuf.Duration validation_token_ttl = 3 [(gogoproto.customname) = "ValidationTokenTTL", (gogoproto.nullable) = false, (gogoproto.stdduration) = true];

  // allowed_emails is a list of globs to restrict emails to. If empty all emails are valid.
  repeated string allowed_emails = 4;
}

message GetSettingsRequest {
  // projection_mask is the set of field paths that represents the settings that
  // will be returned in the operation. If the list is empty all settings will be returned.
  google.protobuf.FieldMask projection_mask = 1;
}

message UpdateSettingsRequest {
  // settings are the settings to be updated.
  IdentityServerSettings settings = 1 [(gogoproto.nullable) = false];

  // update_mask is the symbolic set of fields that will be affected in the update
  // operation. Fields not included in the update_mask are not changed and ignored
  // in the request. Must be non-empty.
  google.protobuf.FieldMask update_mask = 2 [(gogoproto.nullable) = false];
}

// IsSettings is the service that provided methods to manage the settings of an
// Identity Server within a tenant.
service IsSettings {
  // GetSettings returns the value of the specified settings.
  rpc GetSettings(GetSettingsRequest) returns (IdentityServerSettings);

  // UpdateSettings updates the settings.
  rpc UpdateSettings(UpdateSettingsRequest) returns (google.protobuf.Empty);
}

message CreateUserRequest {
  // user is the user to be created.
  User user = 1 [(gogoproto.nullable) = false];

  // invitation_token is the token provided within the registration process to
  // be able to create an user account.
  // This token is only required when the Identity Server registration mode is
  // set to "invitation only", otherwise it will be ignored.
  string invitation_token = 2;
}

message UpdateUserRequest {
  // User is the user to be updated.
  User user = 1 [(gogoproto.nullable) = false];

  // update_mask is the symbolic set of fields that will be affected in the update
  // operation. Fields not included in the update_mask are not changed and ignored
  // in the request. Must be non-empty.
  google.protobuf.FieldMask update_mask = 2 [(gogoproto.nullable) = false];
}

message UpdateUserPasswordRequest {
  // old is the user's old password.
  string old = 1;

  // new is the user's new password.
  string new = 2;
}

message GenerateUserAPIKeyRequest {
  // name is the name of the API key to be generated.
  string name = 1;

  // rights the are rights the generated API key will bear.
  repeated Right rights = 2;
}

message ListUserAPIKeysResponse {
  // api_keys are the API keys that the user has currently registered.
  repeated APIKey api_keys = 1 [(gogoproto.nullable) = false, (gogoproto.customname) = "APIKeys"];
}

message UpdateUserAPIKeyRequest {
  // name is the name of the user API key to be updated.
  string name = 1;

  // rights are the list of rights that will be set.
  repeated Right rights = 2;
}

message RemoveUserAPIKeyRequest {
  // name is the name of the user API key to be removed.
  string name = 1;
}

message ValidateUserEmailRequest {
  // token is the token sent to the user's email address in order to validate it.
  string token = 1;
}

message ListAuthorizedClientsResponse {
  // clients is the list of clients an user has currently authorized.
  repeated Client clients = 1 [(gogoproto.nullable) = false];
}

// IsUser is the interface that provides methods to manage users in the Identity Server.
service IsUser {
  // CreateUser creates a new user on the network.
  rpc CreateUser(CreateUserRequest) returns (google.protobuf.Empty);

  // GetUser returns the profile of an user by ID. If the user identifier is empty it
  // returns the profile of the authenticated user.
  rpc GetUser(UserIdentifier) returns (User);

  // UpdateUser edits the profile of the authenticated user.
  rpc UpdateUser(UpdateUserRequest) returns (google.protobuf.Empty);

  // UpdateUserPassword sets a new password for the authenticated user account.
  rpc UpdateUserPassword(UpdateUserPasswordRequest) returns (google.protobuf.Empty);

  // DeleteUser permantly deletes the user account of the authenticated user.
  rpc DeleteUser(google.protobuf.Empty) returns (google.protobuf.Empty);

  // GenerateUserAPIKey generates a new API key for the authenticated user and returns it.
  rpc GenerateUserAPIKey(GenerateUserAPIKeyRequest) returns (APIKey);

  // ListUserAPIKeys returns all the user API keys that the authenticated user has.
  rpc ListUserAPIKeys(google.protobuf.Empty) returns (ListUserAPIKeysResponse);

  // UpdateUserAPIKey updates the rights of an API key of the authenticated user.
  rpc UpdateUserAPIKey(UpdateUserAPIKeyRequest) returns (google.protobuf.Empty);

  // RemoveUserAPIKey removes an API key from the authenticated user.
  rpc RemoveUserAPIKey(RemoveUserAPIKeyRequest) returns (google.protobuf.Empty);

  // ValidateUserEmail validates the user's email address of the authenticated
  // user by using the token sent to the user's email address.
  rpc ValidateUserEmail(ValidateUserEmailRequest) returns (google.protobuf.Empty);

  // RequestUserEmailValidation re-issues a new email validation token and sends
  // it to the user's email address so he can validate it. Any previous validation
  // token that has not been used will be revoked.
  rpc RequestUserEmailValidation(google.protobuf.Empty) returns (google.protobuf.Empty);

  // ListAuthorizedClients returns the list of clients that the authenticated user
  // has currently authorized to access its account.
  rpc ListAuthorizedClients(google.protobuf.Empty) returns (ListAuthorizedClientsResponse);

  // RevokeClient revokes the access of an authorized client to the authenticated
  // user's account.
  rpc RevokeAuthorizedClient(ClientIdentifier) returns (google.protobuf.Empty);
}

message CreateApplicationRequest {
  // application is the application to be created.
  Application application = 1 [(gogoproto.nullable) = false];
}

message ListApplicationsResponse {
  // applications is the list of applications the authenticated user has access to.
  repeated Application applications = 1 [(gogoproto.nullable) = false];
}

message UpdateApplicationRequest {
  // application is the application to be updated.
  Application application = 1 [(gogoproto.nullable) = false];

  // update_mask is the set of field paths that will be affected in the update
  // operation. Fields not included in the update_mask are not changed and ignored
  // in the request. Must be non-empty.
  google.protobuf.FieldMask update_mask = 2 [(gogoproto.nullable) = false];
}

message GenerateApplicationAPIKeyRequest {
  // application_id is the application's ID which API key will be added to.
  ApplicationIdentifier application_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  // name is the name of the API key to be generated.
  string name = 2;

  // rights the are rights the generated API key will bear.
  repeated Right rights = 3;
}

message ListApplicationAPIKeysResponse {
  // api_keys are the API keys that the application has currently registered.
  repeated APIKey api_keys = 1 [(gogoproto.nullable) = false, (gogoproto.customname) = "APIKeys"];
}

message UpdateApplicationAPIKeyRequest {
  // application_id is the application's ID which an API key will be modified.
  ApplicationIdentifier application_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  // name is the name of the application API key to be updated.
  string name = 2;

  // rights are the list of rights that will be set.
  repeated Right rights = 3;
}

message RemoveApplicationAPIKeyRequest {
  // application_id is the application's ID which the API key will be removed from.
  ApplicationIdentifier application_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  // name is the name of the application API key to be removed.
  string name = 2;
}

message ListApplicationCollaboratorsResponse {
  // collaborators is the list of collaborators the application has.
  repeated ApplicationCollaborator collaborators = 1 [(gogoproto.nullable) = false];
}

message ListApplicationRightsResponse {
  // rights are the rights that a caller has to an application.
  repeated Right rights = 1;
}

// IsApplication is the interface that provides methods to manage applications
// in the Identity Server.
service IsApplication {
  // CreateApplication creates a new application on the network.
  rpc CreateApplication(CreateApplicationRequest) returns (google.protobuf.Empty);

  // GetApplication finds an application by ID and retrieves it.
  rpc GetApplication(ApplicationIdentifier) returns (Application);

  // ListApplications returns all the applications where the authenticated user
  // has access to.
  rpc ListApplications(google.protobuf.Empty) returns (ListApplicationsResponse);

  // UpdateApplication edits an application.
  rpc UpdateApplication(UpdateApplicationRequest) returns (google.protobuf.Empty);

  // DeleteApplication permantly deletes an application.
  rpc DeleteApplication(ApplicationIdentifier) returns (google.protobuf.Empty);

  // GenerateApplicationAPIKey generates a new API key for a given application
  // and returns it.
  rpc GenerateApplicationAPIKey(GenerateApplicationAPIKeyRequest) returns (APIKey);

  // ListApplicationAPIKeys returns all the application API keys that a given
  // application has.
  rpc ListApplicationAPIKeys(ApplicationIdentifier) returns (ListApplicationAPIKeysResponse);

  // UpdateApplicationAPIKey updates the rights of a given application API key.
  rpc UpdateApplicationAPIKey(UpdateApplicationAPIKeyRequest) returns (google.protobuf.Empty);

  // RemoveApplicationAPIKey removes a given API key from an application.
  rpc RemoveApplicationAPIKey(RemoveApplicationAPIKeyRequest) returns (google.protobuf.Empty);

  // SetApplicationCollaborator sets a collaborator for a given application. If
  // the list of rights is empty the collaborator will be removed.
  rpc SetApplicationCollaborator(ApplicationCollaborator) returns (google.protobuf.Empty);

  // ListApplicationCollaborators returns all the collaborators for a given application.
  rpc ListApplicationCollaborators(ApplicationIdentifier) returns (ListApplicationCollaboratorsResponse);

  // ListApplicationRights returns all the rights that the caller has to the specified application.
  rpc ListApplicationRights(ApplicationIdentifier) returns (ListApplicationRightsResponse);
}

message CreateGatewayRequest {
  // gateway is the gateway to be created.
  Gateway gateway = 1 [(gogoproto.nullable) = false];
}

message ListGatewaysResponse {
  // gateways it the list of gateways the authenticated user has access to.
  repeated Gateway gateways = 1 [(gogoproto.nullable) = false];
}

message UpdateGatewayRequest {
  // gateway is the gateway to be updated.
  Gateway gateway = 1 [(gogoproto.nullable) = false];

  // update_mask is the set of field paths that will be affected in the update
  // operation. Fields not included in the update_mask are not changed and ignored
  // in the request. Must be non-empty.
  google.protobuf.FieldMask update_mask = 2 [(gogoproto.nullable) = false];
}

message GenerateGatewayAPIKeyRequest {
  // gateway_id is the gateway's ID which API key will be added to.
  GatewayIdentifier gateway_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  // name is the name of the API key to be generated.
  string name = 2;

  // rights the are rights the generated API key will bear.
  repeated Right rights = 3;
}

message ListGatewayAPIKeysResponse {
  // api_keys are the API keys that the gateways has currently registered.
  repeated APIKey api_keys = 1 [(gogoproto.nullable) = false, (gogoproto.customname) = "APIKeys"];
}

message UpdateGatewayAPIKeyRequest {
  // gateway_id is the gateway's ID which an API key will be modified.
  GatewayIdentifier gateway_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  // name is the name of the gateway API key to be updated.
  string name = 2;

  // rights are the list of rights that will be set.
  repeated Right rights = 3;
}

message RemoveGatewayAPIKeyRequest {
  // gateway_id is the gateway's ID which API key will be removed from.
  GatewayIdentifier gateway_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  // name is the name of the gateway API key to be removed.
  string name = 2;
}

message ListGatewayCollaboratorsResponse {
  // collaborators is the list of collaborators a gateway has.
  repeated GatewayCollaborator collaborators = 1 [(gogoproto.nullable) = false];
}

message ListGatewayRightsResponse {
  // rights are the rights that a caller has to a gateway.
  repeated Right rights = 1;
}

// IsGateway is the interface that provides methods to manage gateways in the
// Identity Server.
service IsGateway {
  // CreateGateway creates a new gateway on the network and returns it.
  rpc CreateGateway(CreateGatewayRequest) returns (google.protobuf.Empty);

  // GetGateway finds a gateway by ID and retrieves it.
  rpc GetGateway(GatewayIdentifier) returns (Gateway);

  // ListGateways returns all the gateways which the authenticated user
  // has access to.
  rpc ListGateways(google.protobuf.Empty) returns (ListGatewaysResponse);

  // UpdateGateway edits a gateway and retrieves the updated version.
  rpc UpdateGateway(UpdateGatewayRequest) returns (google.protobuf.Empty);

  // DeleteGateway permantly deletes a gateway.
  rpc DeleteGateway(GatewayIdentifier) returns (google.protobuf.Empty);

  // GenerateGatewayAPIKey generates a new API key for a given gateway and
  // returns it.
  rpc GenerateGatewayAPIKey(GenerateGatewayAPIKeyRequest) returns (APIKey);

  // ListGatewayAPIKeys returns all the gateway API keys that a given gateway has.
  rpc ListGatewayAPIKeys(GatewayIdentifier) returns (ListGatewayAPIKeysResponse);

  // UpdateGatewayAPIKey updates the rights of a gateway API key.
  rpc UpdateGatewayAPIKey(UpdateGatewayAPIKeyRequest) returns (google.protobuf.Empty);

  // RemoveGatewayAPIKey removes a given API key from a gateway.
  rpc RemoveGatewayAPIKey(RemoveGatewayAPIKeyRequest) returns (google.protobuf.Empty);

  // SetGatewayCollaborator sets a collaborator for a given gateway. If the list
  // of rights is empty the collaborator will be removed.
  rpc SetGatewayCollaborator(GatewayCollaborator) returns (google.protobuf.Empty);

  // ListGatewayCollaborators returns all the collaborators for a given gateway.
  rpc ListGatewayCollaborators(GatewayIdentifier) returns (ListGatewayCollaboratorsResponse);

  // ListGatewayRights returns all the rights that the caller has to the specified gateway.
  rpc ListGatewayRights(GatewayIdentifier) returns (ListGatewayRightsResponse);
}

message CreateClientRequest {
  // client is the client to be created.
  Client client = 1 [(gogoproto.nullable) = false];
}

message ListClientsResponse {
  // clients is a list of third-party clients.
  repeated Client clients = 1 [(gogoproto.nullable) = false];
}

message UpdateClientRequest {
  // client is the client to be updated.
  Client client = 1 [(gogoproto.nullable) = false];

  // update_mask is the set of field paths that will be affected in the update
  // operation. Fields not included in the update_mask are not changed and ignored
  // in the request. Must be non-empty.
  google.protobuf.FieldMask update_mask = 2 [(gogoproto.nullable) = false];
}

// IsClient is the interface that provides methods to manage third-party clients
// in the Identity Server.
service IsClient {
  // CreateClient sends a request to create a third-party client. The request
  // has to be approved by the admins.
  rpc CreateClient(CreateClientRequest) returns (google.protobuf.Empty);

  // GetClient finds a client by ID and retrieves it.
  rpc GetClient(ClientIdentifier) returns (Client);

  // ListClients returns all the clients the authenticated user has created.
  rpc ListClients(google.protobuf.Empty) returns (ListClientsResponse);

  // UpdateClient sends a request to update a client.
  rpc UpdateClient(UpdateClientRequest) returns (google.protobuf.Empty);

  // DeleteClient permantly deletes a client.
  rpc DeleteClient(ClientIdentifier) returns (google.protobuf.Empty);
}
