// Copyright Â© 2017 The Things Network Foundation, distributed under the MIT license (see LICENSE file)

syntax = "proto3";

import "github.com/gogo/protobuf/gogoproto/gogo.proto";
import "github.com/TheThingsNetwork/ttn/api/application.proto";
import "github.com/TheThingsNetwork/ttn/api/client.proto";
import "github.com/TheThingsNetwork/ttn/api/collaborator.proto";
import "github.com/TheThingsNetwork/ttn/api/rights.proto";
import "github.com/TheThingsNetwork/ttn/api/identifiers.proto";
import "github.com/TheThingsNetwork/ttn/api/gateway.proto";
import "github.com/TheThingsNetwork/ttn/api/user.proto";
import "google/protobuf/empty.proto";

package ttn.v3;

option go_package = "github.com/TheThingsNetwork/ttn/pkg/ttnpb";

// GtwGr implements a Gateway Registry service.
service GtwGr {
  // PullConfiguration sends a new GatewayConfiguration, with all the latest values,
  // at connection and when a gateway's configuration is updated.
  rpc PullConfiguration(GatewayIdentifier) returns (stream GatewayConfiguration);
}

message CreateUserRequest {
  // user_id is the ID of the user.
  UserIdentifier user_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  // email address of the user.
  string email = 2;

  // password is the user's unencrypted password.
  string password = 3;

  // name is the user's full name.
  string name = 4;

  // reserved fields in order to make the message binary compatible with User.
  reserved 5,6,7,8,9;
}

message UpdateUserRequest {
  // reserved field in order to make the message binary compatible with User.
  reserved 1;

  // email is the new email of the user.
  string email = 2;

  // reserved field in order to make the message binary compatible with User.
  reserved 3;

  // name is the new name of the user.
  string name = 4;

  // reserved fields in order to make the message binary compatible with User.
  reserved 5,6,7,8,9;
}

message UpdateUserPasswordRequest {
  // old is the user's old password.
  string old = 1;

  // new is the user's new password.
  string new = 2;
}

// IsUser is the interface that provides methods to manage users in the Identity Server.
service IsUser {
  // CreateUser creates a new user on the network.
  rpc CreateUser(CreateUserRequest) returns (google.protobuf.Empty);

  // GetUser returns the profile of an user by ID. If the user identifier is empty it
  // returns the profile of the authenticated user.
  rpc GetUser(UserIdentifier) returns (User);

  // UpdateUser edits the profile of the authenticated user.
  rpc UpdateUser(UpdateUserRequest) returns (google.protobuf.Empty);

  // UpdateUserPassword sets a new password for the authenticated user account.
  rpc UpdateUserPassword(UpdateUserPasswordRequest) returns (google.protobuf.Empty);

  // DeleteUser permantly deletes the user account of the authenticated user.
  rpc DeleteUser(google.protobuf.Empty) returns (google.protobuf.Empty);
}

message CreateApplicationRequest {
  // application_id is the ID of the application to be created.
  ApplicationIdentifier application_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  // description is the description of the application.
  string description = 2;

  // reserved fields in order to make the message binary compatible with Application.
  reserved 3,4,5,6;
}

message ListApplicationsResponse {
  repeated Application applications = 1 [(gogoproto.nullable) = false];
}

message UpdateApplicationRequest {
  ApplicationIdentifier application_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  // description is the description of the application.
  string description = 2;

  // reserved fields in order to make the message binary compatible with Application.
  reserved 3,4,5,6;
}

message GenerateApplicationAPIKeyRequest {
  ApplicationIdentifier application_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  // key_name is the name of the API key to be generated.
  string key_name = 2;

  // rights the are rights the generated API key will bear.
  repeated Right rights = 3;
}

message RemoveApplicationAPIKeyRequest {
  ApplicationIdentifier application_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  // key_name is the name of the API key to be removed.
  string key_name = 2;
}

message SetApplicationCollaboratorRequest {
  ApplicationIdentifier application_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  Collaborator collaborator = 2 [(gogoproto.embed) = true, (gogoproto.nullable) = false];
}

message ListApplicationCollaboratorsResponse {
  repeated Collaborator collaborators = 1 [(gogoproto.nullable) = false];
}

message ListApplicationRightsResponse {
  // rights is a list of rights that an user holds for an application.
  repeated Right rights = 3;
}

// IsApplication is the interface that provides methods to manage applications
// in the Identity Server.
service IsApplication {
  // CreateApplication creates a new application on the network.
  rpc CreateApplication(CreateApplicationRequest) returns (google.protobuf.Empty);

  // GetApplication finds an application by ID and retrieves it.
  rpc GetApplication(ApplicationIdentifier) returns (Application);

  // ListApplications returns all the applications where the authenticated user
  // has access to.
  rpc ListApplications(google.protobuf.Empty) returns (ListApplicationsResponse);

  // UpdateApplication edits an application.
  rpc UpdateApplication(UpdateApplicationRequest) returns (google.protobuf.Empty);

  // DeleteApplication permantly deletes an application.
  rpc DeleteApplication(ApplicationIdentifier) returns (google.protobuf.Empty);

  // GenerateApplicationAPIKey generates a new API key for a given application
  // and returns it.
  rpc GenerateApplicationAPIKey(GenerateApplicationAPIKeyRequest) returns (APIKey);

  // RemoveApplicationAPIKey removes a given API key from an application.
  rpc RemoveApplicationAPIKey(RemoveApplicationAPIKeyRequest) returns (google.protobuf.Empty);

  // SetApplicationCollaborator sets a collaborator for a given application. If
  // the list of rights is empty the collaborator will be removed.
  rpc SetApplicationCollaborator(SetApplicationCollaboratorRequest) returns (google.protobuf.Empty);

  // ListApplicationCollaborators returns all the collaborators for a given application.
  rpc ListApplicationCollaborators(ApplicationIdentifier) returns (ListApplicationCollaboratorsResponse);

  // ListApplicationRights returns all the rights that the authenticated user has
  // for a given application.
  rpc ListApplicationRights(ApplicationIdentifier) returns (ListApplicationRightsResponse);
}

message CreateGatewayRequest {
  // gateway_id is the Gateway's ID to be created.
  GatewayIdentifier gateway_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  // description is the description of the gateway.
  string description = 2;

  // reserved field in order to make the message binary compatible with Gateway.
  reserved 3;

  // frequency_plan_id indicates the ID of the frequency plan.
  string frequency_plan_id = 4 [(gogoproto.customname) = "FrequencyPlanID"];

  // reserved field in order to make the message binary compatible with Gateway.
  reserved 5;

  // privacy_settings defines the different privacy settings for this gateway.
  GatewayPrivacySettings privacy_settings = 6 [(gogoproto.nullable) = false];

  // auto_update indicates whether or not the gateway should be able to
  // automatically fetch and execute firmware updates.
  bool auto_update = 7;

  // platform is the gateway platform, e.g. "The Things Gateway" or "Kerklink iBTS"
  string platform = 8;

  // antennas is all the antennas that the gateway has.
  repeated GatewayAntenna antennas = 9 [(gogoproto.nullable) = false];

  // attributes is a free form map of attributes.
  map<string, string> attributes = 10;

  // cluster_address indicates the URI of the gateway server cluster to connect to,
  // in a "<ip>:<port>" format.
  string cluster_address = 11;

  // contact_account is the user ID that will be displayed (given the set privacy
  // settings) as contact person for this gateway.
  // TODO(gomezjdaniel): allow to use an organization ID as contact account when
  // they are added.
  UserIdentifier contact_account = 12 [(gogoproto.nullable) = false];

  // reserved fields in order to make the message binary compatible with Gateway.
  reserved 13,14,15;
}

message ListGatewaysResponse {
  repeated Gateway gateways = 1 [(gogoproto.nullable) = false];
}

message UpdateGatewayRequest {
  GatewayIdentifier gateway_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  // description is the description of the gateway.
  string description = 2;

  // reserved field in order to make the message binary compatible with Gateway.
  reserved 3;

  // frequency_plan_id indicates the ID of the frequency plan.
  string frequency_plan_id = 4 [(gogoproto.customname) = "FrequencyPlanID"];

  // reserved field in order to make the message binary compatible with Gateway.
  reserved 5;

  // privacy_settings defines the different privacy settings for this gateway.
  GatewayPrivacySettings privacy_settings = 6 [(gogoproto.nullable) = false];

  // auto_update indicates whether or not the gateway should be able to
  // automatically fetch and execute firmware updates.
  bool auto_update = 7;

  // platform is the gateway platform, e.g. "The Things Gateway" or "Kerklink iBTS"
  string platform = 8;

  // antennas is all the antennas that the gateway has.
  repeated GatewayAntenna antennas = 9 [(gogoproto.nullable) = false];

  // attributes is a free form map of attributes.
  map<string, string> attributes = 10;

  // cluster_address indicates the URI of the gateway server cluster to connect to,
  // in a "<ip>:<port>" format.
  string cluster_address = 11;

  // contact_account is the user ID that will be displayed (given the set privacy
  // settings) as contact person for this gateway.
  // TODO(gomezjdaniel): allow to use an organization ID as contact account when
  // they are added.
  UserIdentifier contact_account = 12 [(gogoproto.nullable) = false];

  // reserved fields in order to make the message binary compatible with Gateway.
  reserved 13,14,15;
}

message SetGatewayCollaboratorRequest {
  GatewayIdentifier gateway_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  Collaborator collaborator = 2 [(gogoproto.embed) = true, (gogoproto.nullable) = false];
}

message ListGatewayCollaboratorsResponse {
  repeated Collaborator collaborators = 1 [(gogoproto.nullable) = false];
}

message ListGatewayOwnersResponse {
  // collaborators is the list of collaborators that have owner rights for the gateway.
  repeated Collaborator collaborators = 1 [(gogoproto.nullable) = false];
}

message ListGatewayRightsResponse {
  // rights is a list of rights that an user has to the gateway.
  repeated Right rights = 1;
}

// IsGateway is the interface that provides methods to manage gateways in the
// Identity Server.
service IsGateway {
  // CreateGateway creates a new gateway on the network and returns it.
  rpc CreateGateway(CreateGatewayRequest) returns (Gateway);

  // GetGateway finds a gateway by ID and retrieves it.
  rpc GetGateway(GatewayIdentifier) returns (Gateway);

  // ListGateways returns all the gateways which the authenticated user
  // has access to.
  rpc ListGateways(google.protobuf.Empty) returns (ListGatewaysResponse);

  // UpdateGateway edits a gateway and retrieves the updated version.
  rpc UpdateGateway(UpdateGatewayRequest) returns (Gateway);

  // DeleteGateway permantly deletes a gateway.
  rpc DeleteGateway(GatewayIdentifier) returns (google.protobuf.Empty);

  // SetGatewayCollaborator sets a collaborator for a given gateway. If the list
  // of rights is empty the collaborator will be removed.
  rpc SetGatewayCollaborator(SetGatewayCollaboratorRequest) returns (google.protobuf.Empty);

  // ListGatewayCollaborators returns all the collaborators for a given gateway.
  rpc ListGatewayCollaborators(GatewayIdentifier) returns (ListGatewayCollaboratorsResponse);

  // ListGatewayRights returns all the rights that the authenticated user has
  // to a given gateway.
  rpc ListGatewayRights(GatewayIdentifier) returns (ListGatewayRightsResponse);
}

message CreateClientRequest {
  // client_id is the client's ID to be created.
  ClientIdentifier client_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  // description is the description of the client.
  string description = 2;

  // secret is the secret used to prove the client identity.
  string secret = 3;

  // callback_uri is the callback URI of the client.
  string callback_uri = 4 [(gogoproto.customname) = "CallbackURI"];

  // reserved fields in order to make the message binary compatible with Client.
  reserved 5,6;

  // grants denotes which OAuth2 flows can the client use to get a token.
  repeated ClientGrant grants = 7;

  // scope denotes what scopes the client will have access to.
  repeated ClientScope scope = 8;

  // reserved fields in order to make the message binary compatible with Client.
  reserved 9,10,11;
}

message ListClientsResponse {
  // clients is a list of third-party clients.
  repeated Client clients = 1 [(gogoproto.nullable) = false];
}

message UpdateClientRequest {
  ClientIdentifier client_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  // description is the description of the client.
  string description = 2;

  // secret is the secret used to prove the client identity.
  string secret = 3;

  // callback_uri is the callback URI of the client.
  string callback_uri = 4 [(gogoproto.customname) = "CallbackURI"];

  // reserved fields in order to make the message binary compatible with Client.
  reserved 5,6;

  // grants denotes which OAuth2 flows can the client use to get a token.
  repeated ClientGrant grants = 7;

  // scope denotes what scopes the client will have access to.
  repeated ClientScope scope = 8;

  // reserved fields in order to make the message binary compatible with Client.
  reserved 9,10,11;
}

message SetClientOfficialRequest {
  ClientIdentifier client_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  // official denotes whether if the client is labeled as an official third-party
  // client by the tenant admin.
  bool official_labeled = 2;
}

message SetClientStateRequest {
  ClientIdentifier client_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  ClientState state = 2;
}

message SetClientCollaboratorRequest {
  ClientIdentifier client_id = 1 [(gogoproto.embed) = true, (gogoproto.nullable) = false];

  Collaborator collaborator = 2 [(gogoproto.embed) = true, (gogoproto.nullable) = false];
}

message ListClientCollaboratorsResponse {
  repeated Collaborator collaborators = 1 [(gogoproto.nullable) = false];
}

message ListClientRightsResponse {
  // rights is a list of rights that an user has to the client.
  repeated Right rights = 1;
}

// IsClient is the interface that provides methods to manage third-party clients
// in the Identity Server.
service IsClient {
  // CreateClient creates a new client on the network.
  rpc CreateClient(CreateClientRequest) returns (google.protobuf.Empty);

  // GetClient finds a client by ID and retrieves it.
  rpc GetClient(ClientIdentifier) returns (Client);

  // ListClients returns all the clients which the authenticated has access to.
  rpc ListClients(google.protobuf.Empty) returns (ListClientsResponse);

  // UpdateClient edits a client.
  rpc UpdateClient(UpdateClientRequest) returns (google.protobuf.Empty);

  // DeleteClient permantly deletes a client.
  rpc DeleteClient(ClientIdentifier) returns (google.protobuf.Empty);

  // SetClientOfficial allows to a tenant admin to add or remove the official
  // label of a third-party client.
  rpc SetClientOfficial(SetClientOfficialRequest) returns (google.protobuf.Empty);

  // SetClientState allows to the tenant admin to set the reviewing state of
  // a third-party client request.
  rpc SetClientState(SetClientStateRequest) returns (google.protobuf.Empty);

  // SetClientCollaborator sets a collaborator for a given third-party client.
  // If the list of rights is empty the collaborator will be removed.
  rpc SetClientCollaborator(SetClientCollaboratorRequest) returns (google.protobuf.Empty);

  // ListClientCollaborators returns all the collaborators for a given third-party client.
  rpc ListClientCollaborators(ClientIdentifier) returns (ListClientCollaboratorsResponse);

  // ListClientRights returns all the rights that the authenticated user has
  // to a given third-party client.
  rpc ListClientRights(ClientIdentifier) returns (ListClientRightsResponse);
}
