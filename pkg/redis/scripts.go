// Code generated by generate_scripts.go. DO NOT EDIT.

package redis

import "github.com/go-redis/redis/v7"

var (
	popTaskScript = redis.NewScript(`local function format_ready(xs)
  local ret = { 'ready', 'id', xs[1][2][1][1] }
  for i, v in ipairs(xs[1][2][1][2]) do
    ret[i+3] = v
  end
  return ret
end
local xs = redis.call('xreadgroup', 'group', ARGV[1], ARGV[2], 'count', '1', 'streams', KEYS[1], '>')
if xs then
  return format_ready(xs)
end
xs = redis.call('xreadgroup', 'group', ARGV[1], ARGV[2], 'NOACK', 'streams', KEYS[2], '>')
if xs then
  local zs = {}
  for i, x in ipairs(xs[1][2]) do
    local start_at, payload
    for j=1,#x[2],2 do
      local name = x[2][j]
      if     name == 'start_at' then start_at = x[2][j+1]
      elseif name == 'payload'  then payload  = x[2][j+1]
      end
    end
    zs[#zs+1] = start_at
    zs[#zs+1] = payload
  end
  redis.call('zadd', KEYS[3], unpack(zs))
end
local zs = redis.call('zrangebyscore', KEYS[3], '-inf', ARGV[3], 'withscores')
if #zs > 0 then
  local members = {}
  for i=1,#zs,2 do
    local member = zs[i]
    members[#members+1] = member
    redis.call('xadd', KEYS[1], '*', 'payload', member, 'start_at', zs[i+1])
  end
  redis.call('zrem', KEYS[3], unpack(members))
  return format_ready(redis.call('xreadgroup', 'group', ARGV[1], ARGV[2], 'count', '1', 'streams', KEYS[1], '>'))
end
local ret = { 'waiting' }
zs = redis.call('zrangebyscore', KEYS[3], '-inf', '+inf', 'withscores', 'limit', '0', '1')
if #zs > 0 then
  ret[#ret+1] = 'next_at'
  ret[#ret+1] = zs[2]
end
xs = redis.call('xrevrange', KEYS[2], '+', '-', 'count', '1')
if xs then
  ret[#ret+1] = 'last_id'
  ret[#ret+1] = xs[1][1]
end
return ret`)
)
